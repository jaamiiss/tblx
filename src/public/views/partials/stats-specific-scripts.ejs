<!-- Page-Specific Scripts for Stats Layout -->
<script>
  // ========================================
  // SCATTER CHART FILTER CONFIGURATION
  // ========================================
  
  // Global filter configuration
  window.ScatterChartFilters = {
    dataSource: [
      { value: 'all', label: 'All Data' },
      { value: 'v1', label: 'V1 Only' },
      { value: 'v2', label: 'V2 Only' }
    ],
    status: [
      { value: 'all', label: 'All Statuses' },
      { value: 'deceased', label: 'Deceased' },
      { value: 'active', label: 'Active' },
      { value: 'incarcerated', label: 'Incarcerated' },
      { value: 'redacted', label: 'Redacted' },
      { value: 'unknown', label: 'Unknown' },
      { value: 'captured', label: 'Captured' }
    ]
  };

  // Function to setup scatter chart filters
  function setupScatterChartFilters() {
    const dataFilter = document.getElementById('dataFilter');
    const statusFilter = document.getElementById('statusFilter');
    
    console.log('Setting up scatter chart filters:', { dataFilter, statusFilter });
    
    // Only add event listeners if they don't already exist and elements are found
    if (dataFilter && !dataFilter.hasAttribute('data-listeners-added')) {
      dataFilter.setAttribute('data-listeners-added', 'true');
      
      dataFilter.addEventListener('change', function() {
        console.log('Data filter changed to:', this.value);
        if (window.statsPageChartsManager && window.statsPageChartsManager.scatterChart) {
          window.statsPageChartsManager.scatterChart.dataFilter = this.value;
          window.statsPageChartsManager.scatterChart.loadData();
          
          // Also update modal chart if it's open
          const modal = document.getElementById('chartModal');
          if (modal && modal.classList.contains('active')) {
            const modalCanvas = document.querySelector('#chartModal canvas');
            if (modalCanvas) {
              const modalChart = Chart.getChart(modalCanvas);
              if (modalChart) {
                // Update modal chart with new data
                window.statsPageChartsManager.scatterChart.loadData().then(() => {
                  const newData = window.statsPageChartsManager.scatterChart.chartData;
                  modalChart.data = newData;
                  modalChart.update();
                });
              }
            }
          }
        }
      });
      console.log('Data filter event listener added');
    } else if (!dataFilter) {
      console.warn('Data filter element not found');
    }
    
    if (statusFilter && !statusFilter.hasAttribute('data-listeners-added')) {
      statusFilter.setAttribute('data-listeners-added', 'true');
      
      statusFilter.addEventListener('change', function() {
        console.log('Status filter changed to:', this.value);
        if (window.statsPageChartsManager && window.statsPageChartsManager.scatterChart) {
          window.statsPageChartsManager.scatterChart.statusFilter = this.value;
          window.statsPageChartsManager.scatterChart.loadData();
          
          // Also update modal chart if it's open
          const modal = document.getElementById('chartModal');
          if (modal && modal.classList.contains('active')) {
            const modalCanvas = document.querySelector('#chartModal canvas');
            if (modalCanvas) {
              const modalChart = Chart.getChart(modalCanvas);
              if (modalChart) {
                // Update modal chart with new data
                window.statsPageChartsManager.scatterChart.loadData().then(() => {
                  const newData = window.statsPageChartsManager.scatterChart.chartData;
                  modalChart.data = newData;
                  modalChart.update();
                });
              }
            }
          }
        }
      });
      console.log('Status filter event listener added');
    } else if (!statusFilter) {
      console.warn('Status filter element not found');
    }
  }

  // ========================================
  // MODAL FUNCTIONS
  // ========================================
  
  // Make modal functions globally accessible
  window.closeChartModal = function() {
    // Use the proper cleanup method from stats page charts manager
    if (window.statsPageCharts && window.statsPageCharts.closeModal) {
      window.statsPageCharts.closeModal();
    } else {
      // Fallback to basic close if manager not available
      const modal = document.getElementById('chartModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.classList.remove('chart-modal-open');
        document.body.style.overflow = '';
      }
    }
  };

  window.openChartModal = function(chartType) {
    const modal = document.getElementById('chartModal');
    if (modal) {
      modal.classList.add('active');
      document.body.classList.add('chart-modal-open');
      document.body.style.overflow = 'hidden';
      
      // Update modal content based on chart type
      const modalTitle = document.getElementById('modalChartTitle');
      if (modalTitle) {
        modalTitle.textContent = `${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Chart - Expanded View`;
      }
    }
  };

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('chartModal');
    if (modal && event.target === modal) {
      window.closeChartModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      window.closeChartModal();
    }
  });

  // ========================================
  // DEMO DATA FUNCTIONS
  // ========================================
  
  function loadStatsCardsDummyData() {
    console.log('Stats cards: Loading dummy data...');
    const statsCards = document.getElementById('statsCards');
    if (statsCards) {
      // Simple dummy data rendering
      statsCards.innerHTML = `
        <div class="stats-cards-container">
          <div class="status-cards-grid">
            <div class="stat-card deceased" onclick="window.location.href='/list/deceased'">
              <div class="stat-number">45</div>
              <div class="stat-label">Deceased</div>
              <div class="stat-percentage">22.4%</div>
            </div>
            <div class="stat-card active" onclick="window.location.href='/list/active'">
              <div class="stat-number">32</div>
              <div class="stat-label">Active</div>
              <div class="stat-percentage">15.9%</div>
            </div>
            <div class="stat-card incarcerated" onclick="window.location.href='/list/incarcerated'">
              <div class="stat-number">28</div>
              <div class="stat-label">Incarcerated</div>
              <div class="stat-percentage">13.9%</div>
            </div>
            <div class="stat-card redacted" onclick="window.location.href='/list/redacted'">
              <div class="stat-number">15</div>
              <div class="stat-label">Redacted</div>
              <div class="stat-percentage">7.5%</div>
            </div>
            <div class="stat-card unknown" onclick="window.location.href='/list/unknown'">
              <div class="stat-number">8</div>
              <div class="stat-label">Unknown</div>
              <div class="stat-percentage">4.0%</div>
            </div>
            <div class="stat-card captured" onclick="window.location.href='/list/captured'">
              <div class="stat-number">12</div>
              <div class="stat-label">Captured</div>
              <div class="stat-percentage">6.0%</div>
            </div>
          </div>
          
          <!-- Total Card -->
          <div class="total-card-container">
            <div class="stat-card total" onclick="window.location.href='/list'">
              <div class="stat-number">201</div>
              <div class="stat-label">Total V1</div>
              <div class="stat-percentage">100%</div>
            </div>
          </div>
        </div>
      `;
    }
  }

  function showQuotaExceededMessage() {
    console.log('Stats: Showing quota exceeded message');
    // Simple alert for now
    alert('API quota exceeded. Please try again later or contact support.');
  }

  function loadDummyDataManually() {
    console.log('Stats: Loading dummy data manually');
    loadStatsCardsDummyData();
    
    // Disable demo mode
    if (window.demoManager) {
      window.demoManager.disableDemoMode();
    }
  }

  // ========================================
  // HTMX HANDLERS - HYBRID APPROACH
  // ========================================
  
  // Handle HTMX JSON responses
  document.addEventListener('htmx:afterRequest', function(event) {
    const path = event.detail.pathInfo.requestPath;
    
    // Handle stats cards JSON response
    if (path.includes('/stats/cards')) {
      console.log('Stats cards: Processing JSON response...');
      
      if (event.detail.successful && event.detail.xhr.responseText) {
        try {
          const data = JSON.parse(event.detail.xhr.responseText);
          renderStatsCards(data);
          console.log('Stats cards: Successfully rendered from JSON data');
        } catch (e) {
          console.error('Stats cards: Failed to parse JSON response:', e);
          loadStatsCardsDummyData(); // Fallback to dummy data
        }
      } else {
        console.warn('Stats cards: Request failed, loading dummy data');
        loadStatsCardsDummyData(); // Fallback to dummy data
      }
    }
    
    // Handle chart JSON responses
    if (path.includes('/stats/chart/')) {
      const chartType = path.split('/stats/chart/')[1];
      console.log(`Chart ${chartType}: Processing JSON response...`);
      
      if (event.detail.successful && event.detail.xhr.responseText) {
        try {
          const data = JSON.parse(event.detail.xhr.responseText);
          createChart(chartType, data);
          console.log(`Chart ${chartType}: Successfully created from JSON data`);
        } catch (e) {
          console.error(`Chart ${chartType}: Failed to parse JSON response:`, e);
        }
      } else {
        console.warn(`Chart ${chartType}: Request failed`);
      }
    }
  });

  // Function to create chart from JSON data
  function createChart(chartType, data) {
    const chartId = `${chartType}Chart`;
    const canvas = document.getElementById(chartId);
    if (!canvas) return;
    
    // Destroy existing chart if any
    if (window[chartId] && window[chartId].destroy) {
      window[chartId].destroy();
    }
    
    // Create new chart based on type
    switch (chartType) {
      case 'pie':
        if (window.PieChart) {
          window[chartId] = new PieChart();
          window[chartId].createChart(data);
        }
        break;
      case 'bar':
        if (window.BarChart) {
          window[chartId] = new BarChart();
          window[chartId].createChart(data);
        }
        break;
      case 'scatter':
        if (window.ScatterChart) {
          window[chartId] = new ScatterChart();
          window[chartId].createChart(data);
        }
        break;
    }
  }

  // Function to render stats cards from JSON data
  function renderStatsCards(data) {
    const statsCards = document.getElementById('statsCards');
    if (!statsCards) return;
    
    const { counts, percentages, v1Total } = data;
    
    statsCards.innerHTML = `
      <div class="stats-cards-container">
        <div class="status-cards-grid">
          <div class="stat-card deceased" onclick="window.location.href='/list/deceased'">
            <div class="stat-number">${counts.deceased}</div>
            <div class="stat-label">Deceased</div>
            <div class="stat-percentage">${percentages.deceased}%</div>
          </div>
          <div class="stat-card active" onclick="window.location.href='/list/active'">
            <div class="stat-number">${counts.active}</div>
            <div class="stat-label">Active</div>
            <div class="stat-percentage">${percentages.active}%</div>
          </div>
          <div class="stat-card incarcerated" onclick="window.location.href='/list/incarcerated'">
            <div class="stat-number">${counts.incarcerated}</div>
            <div class="stat-label">Incarcerated</div>
            <div class="stat-percentage">${percentages.incarcerated}%</div>
          </div>
          <div class="stat-card redacted" onclick="window.location.href='/list/redacted'">
            <div class="stat-number">${counts.redacted}</div>
            <div class="stat-label">Redacted</div>
            <div class="stat-percentage">${percentages.redacted}%</div>
          </div>
          <div class="stat-card unknown" onclick="window.location.href='/list/unknown'">
            <div class="stat-number">${counts.unknown}</div>
            <div class="stat-label">Unknown</div>
            <div class="stat-percentage">${percentages.unknown}%</div>
          </div>
          <div class="stat-card captured" onclick="window.location.href='/list/captured'">
            <div class="stat-number">${counts.captured}</div>
            <div class="stat-label">Captured</div>
            <div class="stat-percentage">${percentages.captured}%</div>
          </div>
        </div>
        
        <!-- Total Card -->
        <div class="total-card-container">
          <div class="stat-card total" onclick="window.location.href='/list'">
            <div class="stat-number">${v1Total}</div>
            <div class="stat-label">Total V1</div>
            <div class="stat-percentage">100%</div>
          </div>
        </div>
      </div>
    `;
  }

  // ========================================
  // CHART INITIALIZATION
  // ========================================
  // INITIALIZATION
  // ========================================
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts after a short delay to ensure all scripts are loaded
    setTimeout(() => {
      if (window.statsPageCharts) {
        console.log('Stats: Initializing charts...');
        window.statsPageCharts.init();
        
        // Setup filters after charts are initialized
        setTimeout(() => {
          setupScatterChartFilters();
        }, 500);
      } else {
        console.warn('Stats: statsPageCharts not available');
      }
    }, 100);
  });
</script>